from flask import Flask, jsonify, request, render_template
import psycopg2
from psycopg2 import OperationalError

app = Flask(__name__)

# Database connection details
DB_CONFIG = {
    "dbname": "postgres",
    "user": "postgres",
    "host": "10.98.11.151",
    "password": "postgres",
    "port": "5432"
}

@app.route("/")
def health_check():
    return "Hi! Visit /db-status to check the database connection status or /query to run SQL queries."

@app.route('/db-status', methods=['GET'])
def db_status():
    try:
        # Attempt to connect to the database
        connection = psycopg2.connect(**DB_CONFIG)
        connection.close()
        return jsonify({"status": "success", "message": "Connected to the database successfully!"})
    except OperationalError as e:
        return jsonify({"status": "failure", "message": str(e)}), 500

@app.route('/query', methods=['GET', 'POST'])
def query_ui():
    if request.method == 'POST':
        query = request.form.get('query', 'SELECT * FROM tep_acct')
        try:
            connection = psycopg2.connect(**DB_CONFIG)
            cursor = connection.cursor()
            cursor.execute(query)
            
            # Fetch column names
            columns = [desc[0] for desc in cursor.description]
            
            # Fetch all rows
            rows = cursor.fetchall()
            
            cursor.close()
            connection.close()
            
            return render_template('query.html', 
                                  query=query, 
                                  columns=columns, 
                                  rows=rows, 
                                  success=True)
        except Exception as e:
            return render_template('query.html', 
                                  query=query, 
                                  error=str(e), 
                                  success=False)
    else:
        # Default query for GET request
        return render_template('query.html', 
                              query='SELECT * FROM tep_acct', 
                              success=None)

# Create a templates folder and put this HTML file there
@app.route('/templates/query.html')
def get_template():
    return """
<!DOCTYPE html>
<html>
<head>
    <title>SQL Query Tool</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .container { max-width: 1000px; margin: 0 auto; }
        .query-form { margin-bottom: 20px; }
        textarea { width: 100%; height: 100px; }
        table { border-collapse: collapse; width: 100%; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #f2f2f2; }
        tr:nth-child(even) { background-color: #f9f9f9; }
        .error { color: red; }
        .success { color: green; }
    </style>
</head>
<body>
    <div class="container">
        <h1>SQL Query Tool</h1>
        <form method="post" class="query-form">
            <label for="query">Enter SQL Query:</label><br>
            <textarea name="query" id="query">{{ query }}</textarea><br><br>
            <input type="submit" value="Execute Query">
        </form>
        
        {% if success == True %}
            <p class="success">Query executed successfully</p>
            <h2>Results:</h2>
            <table>
                <thead>
                    <tr>
                        {% for column in columns %}
                            <th>{{ column }}</th>
                        {% endfor %}
                    </tr>
                </thead>
                <tbody>
                    {% for row in rows %}
                        <tr>
                            {% for cell in row %}
                                <td>{{ cell }}</td>
                            {% endfor %}
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        {% elif success == False %}
            <p class="error">Error: {{ error }}</p>
        {% endif %}
    </div>
</body>
</html>
"""

if __name__ == "__main__":
    app.run(host='0.0.0.0', port=8080, debug=True)